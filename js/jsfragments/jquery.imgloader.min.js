/*! jQuery.ImgLoader - v0.1.0 -  2/26/2012
 * https://github.com/Takazudo/jQuery.ImgLoader
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */
(function(){var a,b,c=Array.prototype.slice,d=Object.prototype.hasOwnProperty,e=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};a=$.ImgLoaderNs={},a.createCachedFunction=function(a){var b;return b={},function(c){return b[c]||(b[c]=$.Deferred(function(b){return a(b,c)}).promise()),b[c]}},a.fetchImg=a.createCachedFunction(function(a,b){var c,d,e;return e=new Image,d=function(){return e.onload=e.onerror=null},a.always(d),c=$(e),e.onload=function(){return a.resolve(c)},e.onerror=function(){return a.reject(c)},e.src=b}),function(){var b;return b={},a.loadImg=function(c){return $.Deferred(function(d){return a.fetchImg(c).then(function(a){var e,f;return b[c]||(b[c]=a),e=b[c],f=e.clone(),b[c]=f,d.resolve(e)},function(a){return d.reject(a)})}).promise()}}(),b=function(a){return $.Deferred(function(b){return setTimeout(function(){return b.resolve()},a)})},a.Event=function(){function a(){this._callbacks={}}return a.prototype.bind=function(a,b){var c,d,e,f,g;c=a.split(" ");for(f=0,g=c.length;f<g;f++)d=c[f],(e=this._callbacks)[d]||(e[d]=[]),this._callbacks[d].push(b);return this},a.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},a.prototype.trigger=function(){var a,b,d,e,f,g,h;a=1<=arguments.length?c.call(arguments,0):[],d=a.shift(),e=(h=this._callbacks)!=null?h[d]:void 0;if(!e)return;for(f=0,g=e.length;f<g;f++){b=e[f];if(b.apply(this,a)===!1)break}return this},a.prototype.unbind=function(a,b){var c,d,e,f,g;if(!a)return this._callbacks={},this;e=(g=this._callbacks)!=null?g[a]:void 0;if(!e)return this;if(!b)return delete this._callbacks[a],this;for(d=0,f=e.length;d<f;d++){c=e[d];if(c!==b)continue;e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},a}(),a.LoaderItem=function(b){function c(a){this.src=a,c.__super__.constructor.apply(this,arguments)}return e(c,b),c.prototype.load=function(){var b=this;return $.Deferred(function(c){return a.loadImg(b.src).pipe(function(a){return b.$img=a,b.trigger("success",b.$img),b.trigger("complete",b.$img),c.resolve(b.$img)},function(a){return b.$img=a,b.trigger("error",b.$img),b.trigger("complete",b.$img),c.reject(b.$img)})}).promise()},c}(a.Event),a.BasicLoader=function(b){function d(){d.__super__.constructor.apply(this,arguments),this.items=[]}return e(d,b),d.prototype.add=function(b){var c;return $.type(b)==="string"&&(c=b,b=new a.LoaderItem(c)),this.items.push(b),b},d.prototype.load=function(){var a,b,d=this;return a=0,b=$.map(this.items,function(b){return b.bind("complete",function(b){return d.trigger("itemload",b,a),a++}).load()}),$.Deferred(function(a){return $.when.apply(d,b).always(function(){var b,e;return e=1<=arguments.length?c.call(arguments,0):[],b=$(e),d.trigger("allload",b),a.resolve(b)})})},d.prototype.kill=function(){return $.each(this.items,function(a,b){return b.unbind()}),this.trigger("kill"),this.unbind(),this},d}(a.Event),a.ChainLoader=function(b){function c(a,b){this._pipesize=a,this._delay=b!=null?b:0,c.__super__.constructor.apply(this,arguments),this._presets=[],this._doneCount=0,this._inLoadCount=0,this._allDoneDefer=$.Deferred()}return e(c,b),c.prototype._finished=function(){return this._doneCount===this._presets.length},c.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},c.prototype._getImgs=function(){return $($.map(this._presets,function(a){return a.item.$img}))},c.prototype._handleNext=function(){var a,b=this;return this._finished()?this._allloadFired?this:(this._allloadFired=!0,a=this._getImgs(),this.trigger("allload",a),this._allDoneDefer.resolve(a),this):($.each(this._presets,function(a,c){return c.started?!0:b._nextLoadAllowed()?(b._inLoadCount++,c.started=!0,c.item.one("complete",function(d){return c.done=!0,setTimeout(function(){var e;return e=function(){return b.trigger("itemload",d,b._doneCount),b._inLoadCount--,b._doneCount++,c.defer.resolve(d),b._handleNext()},a===0?e():b._presets[a-1].defer.always(function(){return e()})},b._delay)}),c.item.load()):!1}),this)},c.prototype.add=function(b){var c,d;return $.type(b)==="string"&&(d=b,b=new a.LoaderItem(d)),c={item:b,done:!1,started:!1,defer:$.Deferred()},this._presets.push(c),c.defer},c.prototype.load=function(){return this._handleNext(),this._allDoneDefer},c.prototype.kill=function(){return $.each(this._presets,function(a,b){return b.item.unbind()}),this.trigger("kill"),this.unbind(),this},c}(a.Event),a.LoaderFacade=function(){function e(b){var c,d=this;if(this instanceof arguments.callee)this.options=c=$.extend({srcs:[],pipesize:0,delay:100},b),c.pipesize?this.loader=new a.ChainLoader(c.pipesize,c.delay):this.loader=new a.BasicLoader,$.each(c.srcs,function(b,c){return d.loader.add(new a.LoaderItem(c))});else return new a.LoaderFacade(b)}var b,d=this;return b=["bind","trigger","load","one","unbind","add","kill"],$.each(b,function(a,b){return e.prototype[b]=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],this.loader[b].apply(this.loader,a)}}),e}.call(this),function(){var c,d,e,f,g;return e={},c=null,d=function(){return $.Deferred(function(a){return $(function(){return c=$('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),$("body").append(c),a.resolve()})}).promise()},f=function(a){return a.naturalWidth===void 0||a.naturalWidth===0||a.naturalHeight===void 0||a.naturalHeight===0?!1:!0},g=function(a,d){var f;return a=a.clone(),f=a[0],$.Deferred(function(g){var h,i,j,k;return k={},a.css({width:"auto",height:"auto"}),h=$("<div></div>").append(a),c.append(h),i=0,j=function(){return k.width=f.naturalWidth||a.width(),k.height=f.naturalHeight||a.height(),i>10?(h.remove(),g.reject()):!k.width||!k.height?(i++,b(100).done(function(){return j()})):(e[d],h.remove(),g.resolve(k))},j()}).promise()},a.calcNaturalWH=a.createCachedFunction(function(b,c){return a.loadImg(c).then(function(a){var h,i;return h=a[0],f(h)?(i={width:h.naturalWidth,height:h.naturalHeight},e[c]=i,b.resolve(i,a)):d().done(function(){return g(a,c).then(function(c){return b.resolve(c,a)},function(){return b.reject()})})},function(){return b.reject()})})}(),$.loadImg=a.loadImg,$.ImgLoader=a.LoaderFacade,$.calcNaturalWH=a.calcNaturalWH}).call(this);
